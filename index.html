<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */

body { font: 12px Arial;}

path { 
    stroke: steelblue;
    stroke-width: 2;
    fill: none;
}

.axis path,
.axis line {
    fill: none;
    stroke: grey;
    stroke-width: 1;
    shape-rendering: crispEdges;
}

</style>
<body>

<!-- load the d3.js library -->    
<script src="http://d3js.org/d3.v3.min.js"></script>
<script src="colorbrewer.js"></script>

<script>

// Set the dimensions of the canvas / graph
var margin = {top: 30, right: 20, bottom: 30, left: 50},
    width = 1300 - margin.left - margin.right,
    height = 810- margin.top - margin.bottom;

var feature_width = 23,
    feature_height = 23;

// Parse the date / time
var parseDate = d3.time.format("%d-%b-%y").parse;

  // Adds the svg canvas
var svg = d3.select("body")
    .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)

var details = svg.append("g")
                 .attr("class","details")
                 .attr("width", 300)
                 .attr("height",500)
                 .attr("transform", "translate(1200,200)")

function handleDeatilsClick(d){
    d3.select(".details").remove()
    details = svg.append("g")
         .attr("class","details")
         .attr("width", 300)
         .attr("height",500)
         .attr("transform", "translate(1200,200)")
}

lines = ["L0","L1","L2","L3"]
x_offsets = [0,0,0,0]
y_offsets = [0,0,0,0]

var process = svg.selectAll(".process")
                .append("g")
                .attr("class","process")
                .data(lines).enter().append("rect")
                .attr("x",function(d,i){return 300*i})
                .attr("width", 280)
                .attr("height", height)
                .attr("fill","none")
                .attr("stroke","black")
                .attr("stroke-width",1)
                .attr("class",function(d){return d});

var colorScale = d3.scale.quantize()
                   .range(colorbrewer.RdYlGn[11])
                   .domain([0.01,0])



// Get the data
d3.json("data/feature_data.json", function(error, data) {

    var max_part_count = d3.max(data, function(d) { return d.total_count; })
    var min_part_count = d3.min(data, function(d) { return d.total_count; })

    var sizeScale = d3.scale.log() //uses stroke width to reduce size of rectangle, so the larger the part count the smaller the stroke width, creating a larger rectangle
                       .range([3,12])
                       .domain([max_part_count,min_part_count])

    svg.selectAll(".features")
       .append("g")
       .attr("class","features")
       .data(data).enter().append("rect")
       .attr("x",function(d){
            line_index = lines.indexOf(d.line)
            offset = x_offsets[line_index] % 10
            x_offsets[line_index] = x_offsets[line_index] + 1
            return (300*line_index + feature_width*offset + 25)
        })
       .attr("y",function(d){
            line_index = lines.indexOf(d.line)
            offset = Math.floor(y_offsets[line_index] / 10)
            y_offsets[line_index] = y_offsets[line_index] + 1
            return (feature_height*offset + 25)
        })
       .attr("width", feature_width)
       .attr("height",feature_height)
       .attr("fill",function(d){return colorScale(d.defective_rate)})
       .attr("stroke","white")
       .attr("stroke-width",function(d){return sizeScale(d.total_count)})
       .attr("class",function(d){return d.feature})
       .on("click", function(d){handleDeatilsClick(d)})

});

/*d3.json("data/path_data.json", function(error, data) {

    var max_part_count = d3.max(data, function(d) { return d.total_count; })
    var min_part_count = d3.min(data, function(d) { return d.total_count; })

    var sizeScale = d3.scale.log() //uses stroke width to reduce size of rectangle, so the larger the part count the smaller the stroke width, creating a larger rectangle
                       .range([1,3])
                       .domain([max_part_count,min_part_count])

    svg.selectAll(".paths")
        .append("g")
        .attr("class","paths")
        .data(data).enter().append("line")
        .attr("stroke",function(d){return colorScale(d.defective_rate)})
        .attr("stroke-width",function(d){return sizeScale(d.total_count)})
        .attr("x1",function(d){
            return parseInt(d3.select("." + d.start_feature).attr("x")) + (feature_width/2)
        })
        .attr("y1",function(d){
            return parseInt(d3.select("." + d.start_feature).attr("y")) + (feature_height/2)
        })
        .attr("x2",function(d){
            return parseInt(d3.select("." + d.end_feature).attr("x")) + (feature_width/2)
        })
        .attr("y2",function(d){
            return parseInt(d3.select("." + d.end_feature).attr("x")) + (feature_width/2)
        })
});*/

</script>
</body>